### 🔸 QUERY

#### 내포된 SQL문의 구분

- SUB QUERY : where절이나 having 절에서 조건식에 사용되는 값을 제공하는 SQL문
- Inline-View : From 절에서 가상의 테이블(가상의 테이블을 뷰 라고함)을 제공하는 SQL문
- Scalar_SUB_QUERY : Select절에서 사용되는 서크붜리
- Correlative Subquery (상호연관 서브쿼리) : 내포된 SQL문에서 메인쿼리의 컬럼을 참조하는 서브쿼리

#### 🔹 SubQuery

- select 문 내부에 정의된 select 문을 서브쿼리라 한다
- SubQuery는 where절의 조건식에서 사용되는 값을 제공한다
    + 이경우 조건식에서 사용되는 값이 SQL을 실행해야만 획득 가능한 값이 경우가 많다

```sql
           select 컬럼, 컬럼
           from 테이블명
           where 조건식 연산자 ( select 컬럼
                               from 테이블명 
                               [where 조건식])
```

✔ 특징

- 한번만 실행된다
- 메인쿼리보다 먼저 실행된다
- 서브쿼리의 실행결과가 메인쿼리의 조건식에서 사용된다.

<br>
❗ 주의 사항

- 서브쿼리는 반드시 괄호 안에 작성
- 서브쿼리는 조건식에서 <b>오른쪽에 위치</b> 시켜서 가독성을 높인다
- 서브쿼리의 실행결과가 단일행 인지 다중행 인지 조사해서 적절한 연산자를 사용한다

<br>

#### ▶ SubQuery의 종류

- 단일행 서브쿼리
- 다중행 서브쿼리
- 다중열 서브쿼리


- 단일행 서브쿼리
    + 서브쿼리의 실행결과로 한 행만 반환된다.
    + 단일행 비교 연산자
        * =, >, >=, <, <=, <>
- 다중행 서브쿼리
    + 서브쿼리의 실행결과로 여러 행이 반환된다.
    + 다중행 비교 연산자
        * in, not in , any, all

- 다중열 서브쿼리
    + 두 개 이상의 컬럼값이 조회조건으로 반환되는 서브쿼리다.
    + 다중열 서브쿼리 형식

  ```sql
    select column, column, ....
    from table1 
    where (column1, column2) in (select column1, column2 
                                 from table2)
  ```
- having절에서 서브쿼리 사용하기
    + group by 절을 사용해서 그룹화하고 그룹함수를 실행한 결과를 필터링하는 having 절에도 서브쿼리를 사용할 수 있다.

  ```sql
    select column, 그룹함수
    from table1
    group by column
    having 그룹함수 연산자 (select column
                            from table)
  ```

---

<br>
❓ 전체 직원의 평균급여 보다 많이 받는 직원의 아이디 , 이름 , 급여 조회

```sql
    select EMPLOYEE_ID, FIRST_NAME, SALARY
    FROM EMPLOYEES
    WHERE SALARY > 평균급여; -- 평군급여를 제공하는 서브쿼리가 필요하다


select EMPLOYEE_ID, FIRST_NAME, salary
from EMPLOYEES
where salary > (select avg(salary)
                from EMPLOYEES);
```

<br>
❓ B등급의 최고 급여보다 급여를 적게받는 직원의 아이디 이름 급여 조회하기

```sql

/*

select EMPLOYEE_ID, FIRST_NAME, salary
from EMPLOYEES
where SALARY < B등급의 최고급여

*/
-- B등급 최고급여 구하기
select *
from SALARY_GRADES;

select MAX_SALARY
from SALARY_GRADES
where GRADE = 'B';

-- 최종 

select EMPLOYEE_ID, FIRST_NAME, salary
from EMPLOYEES
where SALARY < (select MAX_SALARY
                from SALARY_GRADES
                where GRADE = 'B');
```

❓ 60번부서의 직원과 같은해에 입사한 직원들의 아이디 이름 입사일을 조회하기

```sql
select TO_CHAR(HIRE_DATE, 'YYYY')
from EMPLOYEES
where DEPARTMENT_ID = 60;


/* [21000][1427] ORA-01427: 단일 행 하위 질의에 2개 이상의 행이 리턴되었습니다. Position: 80 */
select FIRST_NAME, HIRE_DATE
from EMPLOYEES
where TO_CHAR(HIRE_DATE, 'YYYY') = (select TO_CHAR(HIRE_DATE, 'YYYY')
                                    from EMPLOYEES
                                    where DEPARTMENT_ID = 60);

-- 최종
select FIRST_NAME, HIRE_DATE
from EMPLOYEES
where TO_CHAR(HIRE_DATE, 'YYYY') IN (select TO_CHAR(HIRE_DATE, 'YYYY')
                                     from EMPLOYEES
                                     where DEPARTMENT_ID = 60);

```
